#include <iostream>
#include <utility>
#include <limits>
#include <iomanip>

using namespace std;

class Transaction {
struct Tran {
    string tranId, name, movieName, date, time;
    float price = 0, total = 0;
    int seats = 0;

    Tran* next;
};
struct Tran* headTran;
Tran* sortedTran;

public:
    void transactionHistory(string id, string name, string movieName, string date, string time, float price, int seat);
    void sortedTranInsert(Tran* newnode);
    void insertSortingTran(Tran* ref);
    void backButton();
    void addTran();
    void viewTran();
    void sortTran();
    void TranPage();
    void searchTran();
} tran;

void Transaction::transactionHistory(string id, string name, string movieName, string date, string time, float price, int seats) {
    auto new_tran = new struct Tran;
    new_tran->tranId = std::move(id);
    new_tran->name = std::move(name);
    new_tran->movieName = std::move(movieName);
    new_tran->date = std::move(date);
    new_tran->time = std::move(time);
    new_tran->price = price;
    new_tran->seats = seats;
    new_tran->total = new_tran->price * new_tran->seats;

    new_tran->next = headTran;
    headTran = new_tran;
}

void Transaction::sortedTranInsert(Tran* newnode) {
    if (sortedTran == nullptr || sortedTran->total <= newnode->total) {
        newnode->next = sortedTran;
        sortedTran = newnode;
    }
    else {
        Tran* current = sortedTran;
        while (current->next != nullptr
               && current->next->total > newnode->total) {
            current = current->next;
        }
        newnode->next = current->next;
        current->next = newnode;
    }
}

void Transaction::insertSortingTran(Tran* ref) {
    sortedTran = nullptr;
    Tran* current = ref;

    while (current != nullptr) {
        Tran* next = current->next;
        sortedTranInsert(current);
        current = next;
    }

    headTran = sortedTran;
}

void Transaction::backButton() {
    cout << "\n[1]Back" << endl;
    opt:
    int choice = 0;
    cin >> choice;
    if (choice == 1) {

    } else if ( !cin.good() || choice != 1) {
        std::cin.clear();
        std::cin.ignore(numeric_limits<streamsize>::max(), '\n');
        cout << "Invalid input! Press 1 to Back.";
        goto opt;
    }
}

void Transaction::addTran() {
    // Title
    cout << "\n=============================Add Purchase==============================";

}

void Transaction::viewTran() {
    // View all function
    struct Tran* show_all;
    show_all = headTran;

    if (show_all == nullptr) {
        cout << "No movie has been recorded in linkedlist\n";
    }
    else {
        cout << "Transaction ID \tName \t Movie Name \tDate \t\tTime \tPrice \t  Seats   Total Amount \n";
        while (show_all != nullptr) {
            show_all->total = show_all->price*show_all->seats;
            cout << show_all->tranId << fixed << setprecision(2) <<
                 "\t\t" << show_all->name <<
                 "\t " << show_all->movieName <<
                 "\t" << show_all->date <<
                 "\t" << show_all->time <<
                 "\tRM" << show_all->price <<
                 "\t  " << show_all->seats <<
                 "\t  RM" << show_all->total <<
                 endl;

            show_all = show_all->next;
        }
    }
}

void Transaction::sortTran() {
    // Title
    cout << "\n===========================Sorted Purchase=============================" << endl;

    // Sort Function
    struct Tran* show_byTotal, temp;
    show_byTotal = headTran;
    if (show_byTotal == nullptr) {
        cout << "No movie has been recorded in linkedlist\n";
    }
    else {
        insertSortingTran(show_byTotal);
        viewTran();
    }

    // Back Button
    backButton();
}

void Transaction::searchTran() {
    // Title
    cout << "\n===========================Search Purchase=============================";

    // Back Button
    backButton();
}

void Transaction::TranPage() {
    menu:
    cout << "\n=================================Menu==================================" << endl;

    cout << "[1] Add Purchase"
            "\n[2] View All Purchase"
            "\n[3] Sort Purchase"
            "\n[4] Search Purchase"
            "\n[5] Exit"
         << endl;
    int choice = 0;
    cin >> choice;
    switch (choice) {
        case 1:
            tran.addTran();
            goto menu;
        case 2:
            cout << "\n===========================View All Purchase===========================" << endl;
            viewTran();
            backButton();
            goto menu;
        case 3:
            tran.sortTran();
            goto menu;
        case 4:
            tran.searchTran();
            goto menu;
        case 5:
            cout << "Are you sure you want to exit? (Y/N)";
            opt:
            char yn;
            cin >> yn;
            if (yn == 'Y' || yn == 'y') {
                break;
            } else if (yn == 'N' || yn == 'n') {
                goto menu;
            } else {
                cout << "Invalid input!!! Please enter Y or N.";
                goto opt;
            }
        default:
            cout << "Invalid input! Please select your choice (1-5)";
            goto menu;
    }
}

int main() {
    tran.transactionHistory("T001", "Michael", "Super gym bros","2/4/2022","08:50",18,2);
    tran.transactionHistory("T003", "Tony","Sanic the","30/2/2022","15:30",16,5);
    tran.transactionHistory("T002", "Sparky","Jack and the","2/4/2022","08:50",20,1);
    tran.transactionHistory("T004", "Bobby","Sanic the","30/2/2022","15:30",16,3);

    tran.TranPage();
}
